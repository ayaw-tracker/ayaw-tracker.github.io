<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Are You Actually Winning?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1024px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Style for the individual player prop rows in the form */
        .player-prop-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)) auto;
            gap: 0.75rem;
            padding: 0.75rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            align-items: center;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(-10px);
            animation: slideIn 0.3s ease forwards;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .player-prop-row.removing {
            animation: slideOut 0.3s ease forwards;
        }

        @keyframes slideOut {
            to {
                opacity: 0;
                transform: translateX(-100%);
            }
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            text-align: center;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        /* Improved input focus states */
        .form-input:focus {
            ring-color: #3b82f6;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Hover effects for buttons */
        .btn-primary {
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* Card specific styles for responsiveness */
        .parlay-card-grid {
            display: grid;
            gap: 1.5rem; /* Gap between cards */
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Auto-fit cards, min width 280px */
        }
        .parlay-card {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Pushes buttons to the bottom */
            border: 1px solid #e5e7eb;
        }
        /* Specific styling for the card summary section */
        .parlay-card-summary {
            cursor: pointer; /* Indicate this part is clickable */
            padding-bottom: 0.75rem; /* Space before the hidden details toggle indicator */
            margin-bottom: 0.75rem; /* Space below the summary before the hidden details */
            border-bottom: 1px dashed #e5e7eb; /* Separator line */
            display: flex;
            flex-direction: column;
            position: relative; /* Needed for absolute positioning of pseudo-element */
        }
        /* New style for the subtle expand/collapse indicator on cards */
        .parlay-card-summary::after {
            /* Removed content to remove the +/-, but kept position for potential future use or alignment */
            content: ''; 
            position: absolute;
            right: 0.75rem; /* Align to the right edge of the card */
            top: 1rem; /* Adjust vertical position */
            font-size: 1.2rem;
            color: #6b7280;
            transition: transform 0.2s ease;
        }

        .parlay-card-summary.expanded::after {
            /* Removed content to remove the +/-, but kept transform for potential future use */
            content: '';
            transform: rotate(180deg); /* Optional: rotate for visual flair */
        }

        .parlay-card-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .parlay-card-detail strong {
            color: #4b5563;
        }
        .parlay-card-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end; /* Align buttons to the right */
        }
        .parlay-card-bets ul {
            margin-top: 0.5rem;
            list-style: none; /* Remove default list style */
            padding-left: 0; /* Remove default padding */
        }
        .parlay-card-bets li {
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
            padding-left: 1.25rem; /* Indent for custom bullet */
            position: relative;
        }
        .parlay-card-bets li::before { 
            content: '•'; /* Custom bullet point */
            color: #6b7280; /* Gray color for bullets */
            position: absolute;
            left: 0;
            font-weight: bold;
        }
        /* Hidden class for toggling details */
        .parlay-card-toggle-details.hidden {
            display: none;
        }

        /* --- Custom CSS for the main collapsible section and arrow --- */
        .parlay-section summary {
          /* Remove default user agent styling for summary */
          list-style: none; /* Removes the default triangle marker */
          outline: none;    /* Removes the focus outline for better aesthetics */
          /* Center the text and make it a flex container for responsiveness */
          display: flex; 
          justify-content: center; /* Center horizontally */
          align-items: center; /* Center vertically */
          transition: font-weight 0.2s ease-in-out; /* Smooth transition for hover effect */
          touch-action: manipulation; /* Added to help fix double-tap on mobile */
        }

        /* Hide the default marker specifically for Webkit browsers (Chrome, Safari) */
        .parlay-section summary::-webkit-details-marker {
          display: none;
        }

        /* Hide the default marker for Firefox */
        .parlay-section summary::marker {
          display: none;
        }

        /* Ensure the heading within the summary doesn't have unwanted bottom margin */
        .parlay-section summary h3 {
          margin-bottom: 0 !important; /* Overrides Tailwind's default margin on h3 */
          font-weight: 600; /* Default font weight for the header */
        }

        /* Remove the arrow styles as it's no longer present */
        .parlay-section .arrow {
          display: none; /* Explicitly hide the arrow span */
        }

        /* Hover effect for summary text boldness */
        .parlay-section summary:hover h3 {
            font-weight: 800; /* Extra bold on hover */
        }

        /* Styling for the content area that expands/collapses */
        .parlay-section .parlay-content {
          padding-top: 1rem; /* Adds padding above the form when expanded */
          border-top: 1px dashed #e5e7eb; /* A subtle dashed line above the content */
          margin-top: 1rem; /* Space between the summary and the dashed line */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <div class="container">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">Are You Actually Winning?</h1>
            <p class="text-gray-600">Track your parlay betting performance honestly</p>
        </header>

        <!-- New Mission Statement Section -->
        <section class="bg-gray-50 p-6 rounded-lg shadow-sm mb-8 text-center">
            <p class="text-gray-700 text-lg font-medium">
                The truth is in the numbers. Let your data tell the story.
            </p>
        </section>

        <!-- Input Form - Now Collapsible and Centered with Hover Effect -->
        <details class="parlay-section bg-white p-6 rounded-lg shadow-sm mb-8">
            <summary class="cursor-pointer flex justify-center items-center text-2xl font-semibold text-gray-700 mb-4">
                <h3>Add New Parlay</h3>
            </summary>
            <div class="parlay-content">
                <form id="parlayForm" class="space-y-6">
                    <!-- Overall Parlay Details -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="result" class="block text-sm font-medium text-gray-700 mb-1">Parlay Result</label>
                            <select id="result" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="Win">Win</option>
                                <option value="Loss">Loss</option>
                                <option value="Push">Push</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="playType" class="block text-sm font-medium text-gray-700 mb-1">Payout Type</label>
                            <select id="playType" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="Power">Power Play</option>
                                <option value="Flex">Flex Play</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="amountWagered" class="block text-sm font-medium text-gray-700 mb-1">Amount Wagered ($)</label>
                            <input type="text" 
                                   id="amountWagered" 
                                   step="0.01" 
                                   min="0" 
                                   placeholder="0.00" 
                                   class="money-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                   required>
                        </div>
                        
                        <div class="lg:col-span-1">
                            <label for="amountWonLoss" class="block text-sm font-medium text-gray-700 mb-1">Amount Won/Loss ($)</label>
                            <input type="text" 
                                   id="amountWonLoss" 
                                   step="0.01" 
                                   placeholder="0.00" 
                                   class="money-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                   required>
                        </div>
                    </div>

                    <!-- Individual Player/Team Bets Section -->
                    <div>
                        <label class="block text-lg font-semibold text-gray-700 mb-3">Individual Player/Team Bets</label>
                        <div id="playerPropInputs" class="space-y-3 mb-4">
                            <!-- Dynamic player prop inputs will be added here -->
                        </div>
                        <button type="button" 
                                 id="addPlayerPropBtn" 
                                 class="w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-150 ease-in-out">
                            + Add Player/Team Bet
                        </button>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-end">
                        <button type="submit" 
                                 id="submitBtn" 
                                 class="bg-blue-600 text-white py-2 px-6 rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                            Add Parlay Entry
                        </button>
                    </div>
                </form>
            </div>
        </details>

        <!-- Summary Statistics -->
        <section class="bg-blue-50 p-6 rounded-lg shadow-sm mb-8">
            <h2 class="text-2xl font-semibold text-blue-800 mb-4">Summary Statistics</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-blue-700 mb-6">
                <div class="bg-white p-4 rounded-lg">
                    <p class="text-sm text-blue-600 mb-1">Total Wagered</p>
                    <p class="text-2xl font-bold">$<span id="totalWagered">0.00</span></p>
                </div>
                
                <div class="bg-white p-4 rounded-lg">
                    <p class="text-sm text-blue-600 mb-1">Net Profit/Loss</p>
                    <p class="text-2xl font-bold">$<span id="netProfitLoss">0.00</span></p>
                </div>
                
                <div class="bg-white p-4 rounded-lg">
                    <p class="text-sm text-blue-600 mb-1">Total Parlays</p>
                    <p class="text-2xl font-bold"><span id="totalParlays">0</span></p>
                </div>
                
                <div class="bg-white p-4 rounded-lg">
                    <p class="text-sm text-green-600 mb-1">Wins</p>
                    <p class="text-xl font-bold text-green-700"><span id="totalWins">0</span></p>
                </div>
                
                <div class="bg-white p-4 rounded-lg">
                    <p class="text-sm text-red-600 mb-1">Losses</p>
                    <p class="text-xl font-bold text-red-700"><span id="totalLosses">0</span></p>
                </div>
                
                <div class="bg-white p-4 rounded-lg">
                    <p class="text-sm text-yellow-600 mb-1">Pushes</p>
                    <p class="text-xl font-bold text-yellow-700"><span id="totalPushes">0</span></p>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg mb-6">
                <label for="successPercentageCalc" class="block text-sm font-medium text-blue-700 mb-2">Success Rate</label>
                <div class="flex items-center space-x-3">
                    <select id="successPercentageCalc" 
                                 class="px-3 py-2 border border-blue-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-blue-800">
                        <option value="parlays">Parlays</option>
                        <option value="props">Individual Props</option>
                    </select>
                    <p class="text-2xl font-bold text-blue-900"><span id="successPercentage">0.00</span>%</p>
                </div>
            </div>

            <div class="text-center">
                <button id="clearAllBtn" 
                                 class="bg-red-500 text-white py-2 px-6 rounded-md shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Clear All Entries
                </button>
            </div>
        </section>

        <!-- Parlay History - Table for Desktop, Cards for Mobile -->
        <section class="bg-white p-6 rounded-lg shadow-sm">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Parlay History</h2>
            
            <!-- Table View (visible on md screens and up) -->
            <div class="overflow-x-auto hidden md:block">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Wagered</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Won/Loss</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Individual Bets</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="parlayTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Parlay table entries will be dynamically added here -->
                    </tbody>
                </table>
            </div>

            <!-- Card View (visible on screens smaller than md) -->
            <div id="parlayHistoryContainer" class="parlay-card-grid block md:hidden">
                <!-- Parlay cards will be dynamically added here -->
            </div>

            <div id="noParlaysMessage" class="text-center text-gray-500 py-12 hidden">
                <p class="text-lg">No parlays tracked yet.</p>
                <p class="text-sm">Add your first parlay above to get started!</p>
            </div>
        </section>
    </div>

    <!-- Welcome Modal -->
    <div id="welcomeModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Welcome to AYAW!</h3>
            <p class="text-gray-700 mb-6">
                This simple tracker helps you <strong>honestly monitor your parlay betting performance</strong> over time.
                Enter your parlay details, including individual prop outcomes, and see your overall profit/loss and success rate.
                All data is saved directly in your browser, so it's always there for you!
            </p>
            <div class="text-center">
                <button id="closeModalBtn" 
                                 class="bg-blue-600 text-white py-2 px-6 rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Got It!
                </button>
            </div>
        </div>
    </div>

    <script>
        // Parlay Tracker Application
class ParlayTracker {
    constructor() {
        this.parlays = [];
        this.currentSuccessCalcMethod = 'parlays';
        this.editingIndex = -1;
        // ADD UNDO PROPERTIES HERE
        this.undoStack = []; // Stores past states for undo functionality
        this.MAX_UNDO_HISTORY = 10; // Limit undo history to prevent excessive memory usage
        
        this.initializeElements();
        this.attachEventListeners();
        this.loadData();
        this.initializeUI();
    }

    // Initialize DOM element references
    initializeElements() {
        // Form elements
        this.parlayForm = document.getElementById('parlayForm');
        this.resultInput = document.getElementById('result');
        this.playTypeInput = document.getElementById('playType');
        this.amountWageredInput = document.getElementById('amountWagered');
        this.amountWonLossInput = document.getElementById('amountWonLoss');
        this.playerPropInputsContainer = document.getElementById('playerPropInputs');
        this.addPlayerPropBtn = document.getElementById('addPlayerPropBtn');
        this.submitBtn = document.getElementById('submitBtn');
        this.clearAllBtn = document.getElementById('clearAllBtn');

        // Table and Card elements
        this.parlayTableBody = document.getElementById('parlayTableBody'); // Re-added for table view
        this.parlayHistoryContainer = document.getElementById('parlayHistoryContainer');
        this.noParlaysMessage = document.getElementById('noParlaysMessage');

        // Summary elements
        this.totalWageredSpan = document.getElementById('totalWagered');
        this.netProfitLossSpan = document.getElementById('netProfitLoss');
        this.totalWinsSpan = document.getElementById('totalWins');
        this.totalLossesSpan = document.getElementById('totalLosses');
        this.totalPushesSpan = document.getElementById('totalPushes');
        this.totalParlaysSpan = document.getElementById('totalParlays');
        this.successPercentageCalcSelect = document.getElementById('successPercentageCalc');
        this.successPercentageSpan = document.getElementById('successPercentage');

        // Modal elements
        this.welcomeModal = document.getElementById('welcomeModal');
        this.closeModalBtn = document.getElementById('closeModalBtn');
    }

    // Attach all event listeners
    attachEventListeners() {
        // Input focus handlers
        this.amountWageredInput.addEventListener('focus', this.handleInputFocus.bind(this));
        this.amountWonLossInput.addEventListener('focus', this.handleInputFocus.bind(this));

        // Money input handlers
        this.amountWageredInput.addEventListener('input', this.sanitizeMoneyInput.bind(this));
        this.amountWageredInput.addEventListener('blur', this.formatCurrencyOnBlur.bind(this));
        this.amountWonLossInput.addEventListener('input', this.sanitizeMoneyInput.bind(this));
        this.amountWonLossInput.addEventListener('blur', this.formatCurrencyOnBlur.bind(this));

        // Auto-calculation handlers
        this.resultInput.addEventListener('change', (event) => this.updateWonLossBasedOnResult(event));
        this.amountWageredInput.addEventListener('input', (event) => this.updateWonLossBasedOnResult(event));

        // Form and button handlers
        this.parlayForm.addEventListener('submit', this.handleFormSubmit.bind(this));
        this.addPlayerPropBtn.addEventListener('click', () => this.addPlayerPropRow());
        // Reverted clearAllBtn to use native confirm()
        this.clearAllBtn.addEventListener('click', this.clearAllParlays.bind(this)); 
        this.successPercentageCalcSelect.addEventListener('change', this.handleSuccessCalcChange.bind(this));
        this.closeModalBtn.addEventListener('click', this.closeWelcomeModal.bind(this));
        // ADD KEYBOARD EVENT LISTENER HERE
        document.addEventListener('keydown', this.handleKeyboardShortcuts.bind(this));
    }

    // Data persistence methods
    // Replace this existing block:
    // loadData() {    const storedParlays = localStorage.getItem('parlays');    if (storedParlays) {        this.parlays = JSON.parse(storedParlays);    }    // ... rest of method}
    loadData() {
        try {
            const storedParlays = localStorage.getItem('parlays');
            if (storedParlays) {
                this.parlays = JSON.parse(storedParlays);
            }
            const storedCalcMethod = localStorage.getItem('successCalcMethod');
            if (storedCalcMethod) {
                this.currentSuccessCalcMethod = storedCalcMethod;
                this.successPercentageCalcSelect.value = storedCalcMethod;
            }
        } catch (error) {
            console.error("Error loading data from localStorage:", error);
            // Optionally, clear corrupted data or show a user message
            // localStorage.removeItem('parlays');
            // localStorage.removeItem('successCalcMethod');
            // alert('Some stored data might be corrupted and could not be loaded.');
            this.parlays = []; // Reset parlays if load fails
        }
    }
    // Replace this existing block:
    // saveData() {    localStorage.setItem('parlays', JSON.stringify(this.parlays));    localStorage.setItem('successCalcMethod', this.currentSuccessCalcMethod);}
    saveData() {
        try {
            localStorage.setItem('parlays', JSON.stringify(this.parlays));
            localStorage.setItem('successCalcMethod', this.currentSuccessCalcMethod);
        } catch (error) {
            console.error("Error saving data to localStorage:", error);
            // Optionally, show a user message if save fails
            // alert('Failed to save data. Please check browser storage settings.');
        }
    }
    // ADD saveStateForUndo() METHOD HERE
    saveStateForUndo() {
        // Create a deep copy of the current parlays array and other relevant state
        const currentState = {
            parlays: JSON.parse(JSON.stringify(this.parlays)), // Deep copy the array and its objects
            // Add other state variables if they also need to be undone, e.g., currentSuccessCalcMethod
            // currentSuccessCalcMethod: this.currentSuccessCalcMethod
        };
        this.undoStack.push(currentState);
        // Trim the undo stack to prevent it from growing too large
        if (this.undoStack.length > this.MAX_UNDO_HISTORY) {
            this.undoStack.shift(); // Remove the oldest state
        }
        console.log(`State saved for undo. Stack size: ${this.undoStack.length}`);
    }


    // Input handling methods
    handleInputFocus(event) {
        // Select all text if the value is '0.00' when focused, for easier clearing
        if (event.target.value === '0.00') {
            event.target.select();
        }
    }

    sanitizeMoneyInput(event) {
        const input = event.target;
        const originalValue = input.value;
        const originalSelectionStart = input.selectionStart; // Save cursor position
        
        let cleanedValue = '';
        let hasDecimal = false;
        let hasNegative = false;
        
        // Track characters removed BEFORE the cursor to adjust its position
        let charsRemovedBeforeCursor = 0;

        for (let i = 0; i < originalValue.length; i++) {
            const char = originalValue[i];
            
            // Allow a leading minus sign only for 'amountWonLoss'
            if (input.id === 'amountWonLoss' && char === '-' && i === 0 && !hasNegative) {
                cleanedValue += char;
                hasNegative = true;
            } else if (char === '.' && !hasDecimal) {
                // Allow only one decimal point
                cleanedValue += char;
                hasDecimal = true;
            } else if (/\d/.test(char)) {
                // Allow digits
                cleanedValue += char;
            } else {
                // If an invalid character is encountered, it will be removed.
                // If this character was before the original cursor position, adjust the cursor offset.
                if (i < originalSelectionStart) {
                    charsRemovedBeforeCursor++;
                }
            }
        }

        // Handle cases like '007' becoming '7' or '0.5'
        // If there's more than one character, the first is '0', and the second isn't '.', remove the leading '0'.
        if (cleanedValue.length > 1 && cleanedValue[0] === '0' && cleanedValue[1] !== '.') {
            cleanedValue = cleanedValue.substring(1);
            // If the removed '0' was before the original cursor, adjust cursor offset
            if (originalSelectionStart > 0 && originalValue[0] === '0') {
                charsRemovedBeforeCursor++;
            }
        }
        
        // Only update the input's value if it has actually changed
        if (originalValue !== cleanedValue) {
            input.value = cleanedValue;
            
            // Calculate the new cursor position
            let newSelectionStart = originalSelectionStart - charsRemovedBeforeCursor;
            
            // Ensure cursor doesn't go below 0 or beyond the new string length
            newSelectionStart = Math.max(0, newSelectionStart);
            newSelectionStart = Math.min(newSelectionStart, cleanedValue.length);

            // Set the cursor position
            input.setSelectionRange(newSelectionStart, newSelectionStart);
        }
    }

    formatCurrencyOnBlur(event) {
        const input = event.target;
        const value = input.value.trim();
        
        // If the value is empty after trimming, leave it empty.
        if (value === '') {
            input.value = '';
            return;
        }

        const numericValue = parseFloat(value.replace(/[^0-9.-]/g, ''));

        // If it's not a valid number after cleaning, clear it.
        if (isNaN(numericValue)) {
            input.value = '';
            return;
        }

        // Format to two decimal places
        input.value = numericValue.toFixed(2);
    }

    updateWonLossBasedOnResult(event) {
        const parlayResult = this.resultInput.value;
        const wageredValue = parseFloat(this.amountWageredInput.value || '0');
        const wonLossInput = this.amountWonLossInput;
        
        // Always trigger update for Loss or Push, or clear for Win
        if (parlayResult === 'Win') {
            wonLossInput.value = ''; 
        } else if (parlayResult === 'Loss') {
            wonLossInput.value = (-wageredValue).toFixed(2);
        } else if (parlayResult === 'Push') {
            wonLossInput.value = '0.00';
        }
    }

    // Player prop management
    addPlayerPropRow(player = '', prop = '', result = 'Win') {
        const div = document.createElement('div');
        div.className = 'player-prop-row';

        div.innerHTML = `
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-0.5">Player/Team</label>
                <input type="text" placeholder="e.g., Lakers" 
                        class="player-name mt-1 block w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm" 
                        value="${player}" required>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-0.5">Prop Type</label>
                <input type="text" placeholder="e.g., Over 25.5 Pts" 
                        class="prop-type mt-1 block w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" 
                        value="${prop}" required>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-0.5">Prop Result</label>
                <select class="individual-result mt-1 block w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="Win"${result === 'Win' ? ' selected' : ''}>Win</option>
                    <option value="Loss"${result === 'Loss' ? ' selected' : ''}>Loss</option>
                    <option value="Push"${result === 'Push' ? ' selected' : ''}>Push</option>
                </select>
            </div>
            <button type="button" 
                    class="remove-prop-btn bg-red-100 text-red-700 p-2 rounded-md hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition ease-in-out duration-150 self-end">
                Remove
            </button>
        `;

        this.playerPropInputsContainer.appendChild(div);

        // Add remove button event listener
        div.querySelector('.remove-prop-btn').addEventListener('click', () => {
            div.classList.add('removing'); // Add class for animation
            div.addEventListener('animationend', () => {
                div.remove();
                if (this.playerPropInputsContainer.children.length === 0) {
                    this.addPlayerPropRow(); // Add an empty row if all are removed
                }
            }, { once: true });
        });
    }

    // Form submission handler
    handleFormSubmit(event) {
        event.preventDefault();

        const bets = this.collectPlayerBets();
        if (!this.validatePlayerBets(bets)) {
            return;
        }

        const parlayData = this.createParlayData(bets);
        
        // Save state for undo before modifying parlays array for Add/Update operations
        this.saveStateForUndo(); 

        if (this.editingIndex !== -1) {
            this.updateParlay(parlayData);
        } else {
            this.addParlay(parlayData);
        }

        this.saveData();
        this.renderParlays();
        this.resetForm();
    }

    collectPlayerBets() {
        const playerBetRows = this.playerPropInputsContainer.querySelectorAll('.player-prop-row');
        const bets = [];

        Array.from(playerBetRows).forEach(row => {
            const playerNameInput = row.querySelector('.player-name');
            const propTypeInput = row.querySelector('.prop-type');
            const individualResultSelect = row.querySelector('.individual-result');

            if (playerNameInput.value.trim() && propTypeInput.value.trim()) {
                bets.push({
                    playerName: playerNameInput.value.trim(),
                    propType: propTypeInput.value.trim(),
                    individualResult: individualResultSelect.value
                });
            }
        });

        return bets;
    }

    validatePlayerBets(bets) {
        const playerBetRows = this.playerPropInputsContainer.querySelectorAll('.player-prop-row');
        let allValid = true;

        Array.from(playerBetRows).forEach(row => {
            const playerNameInput = row.querySelector('.player-name');
            const propTypeInput = row.querySelector('.prop-type');

            const isPlayerEmpty = !playerNameInput.value.trim();
            const isPropEmpty = !propTypeInput.value.trim();

            if (isPlayerEmpty || isPropEmpty) {
                allValid = false;
                playerNameInput.classList.add('border-red-500');
                propTypeInput.classList.add('border-red-500');
            } else {
                playerNameInput.classList.remove('border-red-500');
                propTypeInput.classList.remove('border-red-500');
            }
        });

        if (!allValid) {
            alert('Please fill in all Player/Team and Prop Type fields for individual bets.');
            return false;
        }

        if (bets.length === 0) {
            alert('Please add at least one individual player/team bet for the parlay.');
            return false;
        }

        return true;
    }

    createParlayData(bets) {
        return {
            date: this.editingIndex === -1 ? new Date().toISOString() : this.parlays[this.editingIndex].date,
            result: this.resultInput.value,
            playType: this.playTypeInput.value,
            amountWagered: parseFloat(this.amountWageredInput.value || '0'),
            amountWonLoss: parseFloat(this.amountWonLossInput.value || '0'),
            bets: bets
        };
    }

    addParlay(parlayData) {
        this.parlays.push(parlayData);
    }

    updateParlay(parlayData) {
        this.parlays[this.editingIndex] = parlayData;
        this.editingIndex = -1;
        this.submitBtn.textContent = 'Add Parlay Entry';
    }

    // Parlay management methods
    editParlay(index) {
        this.editingIndex = index;
        const parlayToEdit = this.parlays[index];

        // Populate form fields
        this.resultInput.value = parlayToEdit.result;
        this.playTypeInput.value = parlayToEdit.playType;
        this.amountWageredInput.value = parseFloat(parlayToEdit.amountWagered).toFixed(2);
        
        const wonLossValue = parseFloat(parlayToEdit.amountWonLoss);
        this.amountWonLossInput.value = wonLossValue > 0 
            ? `+${wonLossValue.toFixed(2)}` 
            : wonLossValue.toFixed(2);

        // Populate player props
        this.playerPropInputsContainer.innerHTML = '';
        if (parlayToEdit.bets && parlayToEdit.bets.length > 0) {
            parlayToEdit.bets.forEach(bet => {
                this.addPlayerPropRow(bet.playerName, bet.propType, bet.individualResult);
            });
        } else {
            this.addPlayerPropRow();
        }

        this.submitBtn.textContent = 'Update Parlay Entry';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Reverted to use native confirm()
    deleteParlay(index) {
        this.saveStateForUndo(); // Save state before the confirm dialog appears
        if (confirm('Are you sure you want to delete this parlay entry? This action cannot be undone.')) {
            this.parlays.splice(index, 1);
            this.saveData();
            this.renderParlays();
            if (this.editingIndex === index) {
                this.resetForm();
            }
        }
    }

    // Reverted to use native confirm()
    clearAllParlays() {
        this.saveStateForUndo(); // Save state before the confirm dialog appears
        if (confirm('Are you sure you want to delete ALL parlay entries? This action cannot be undone.')) {
            this.parlays = [];
            this.saveData();
            this.renderParlays();
            this.resetForm();
        }
    }

    // ADD undo() METHOD HERE
    undo() {
        if (this.undoStack.length > 0) {
            const previousState = this.undoStack.pop();
            this.parlays = previousState.parlays;
            // Restore other state variables if they were saved in the undo state
            // this.currentSuccessCalcMethod = previousState.currentSuccessCalcMethod; 
            
            this.saveData(); // Save the restored state to localStorage
            this.renderParlays(); // Re-render the UI
            this.resetForm(); // Reset form in case an edit was undone
            console.log(`Undo performed. Stack size: ${this.undoStack.length}`);
        } else {
            console.log("Nothing to undo.");
            alert("Nothing to undo!"); // Reverted to native alert for this message
        }
    }

    // UI rendering and updates
    renderParlays() {
        this.parlayTableBody.innerHTML = '';
        this.parlayHistoryContainer.innerHTML = '';

        if (this.parlays.length === 0) {
            this.noParlaysMessage.classList.remove('hidden');
            return;
        } else {
            this.noParlaysMessage.classList.add('hidden');
        }

        this.parlays.forEach((parlay, index) => {
            // Render for Table View
            const row = this.createTableRow(parlay, index);
            this.parlayTableBody.appendChild(row);

            // Render for Card View
            const card = this.createCard(parlay, index);
            this.parlayHistoryContainer.appendChild(card);
        });
        this.updateSummaryStatistics();
    }

    createTableRow(parlay, index) {
        const row = document.createElement('tr');
        row.className = 'bg-white border-b hover:bg-gray-50'; // Tailwind classes for rows

        const formattedDate = new Date(parlay.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        const wonLossClass = parlay.amountWonLoss > 0 ? 'text-green-600 font-semibold' : (parlay.amountWonLoss < 0 ? 'text-red-600 font-semibold' : 'text-gray-600');
        const wonLossSign = parlay.amountWonLoss > 0 ? '+' : '';

        const betsHtml = parlay.bets.map(bet => 
            `<li>${bet.playerName}: ${bet.propType} (${bet.individualResult})</li>`
        ).join('');

        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formattedDate}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${parlay.result}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${parlay.playType}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${parlay.amountWagered.toFixed(2)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm ${wonLossClass}">${wonLossSign}$${parlay.amountWonLoss.toFixed(2)}</td>
            <td class="px-6 py-4 text-sm text-gray-500">
                <ul class="list-disc list-inside text-xs">
                    ${betsHtml}
                </ul>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button onclick="tracker.editParlay(${index})" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                <button onclick="tracker.deleteParlay(${index})" class="text-red-600 hover:text-red-900">Delete</button>
            </td>
        `;
        return row;
    }

    createCard(parlay, index) {
        const card = document.createElement('div');
        card.className = 'parlay-card'; // This class has padding, border, shadow

        const formattedDate = new Date(parlay.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        const wonLossClass = parlay.amountWonLoss > 0 ? 'text-green-600 font-bold' : (parlay.amountWonLoss < 0 ? 'text-red-600 font-bold' : 'text-gray-600');
        const wonLossSign = parlay.amountWonLoss > 0 ? '+' : '';

        const betsHtml = parlay.bets.map(bet => 
            `<li>${bet.playerName}: ${bet.propType} (${bet.individualResult})</li>`
        ).join('');

        card.innerHTML = `
            <div class="parlay-card-summary">
                <div class="parlay-card-detail">
                    <span class="text-gray-600">Date:</span> <strong>${formattedDate}</strong>
                </div>
                <div class="parlay-card-detail">
                    <span class="text-gray-600">Result:</span> <strong class="${parlay.result === 'Win' ? 'text-green-600' : parlay.result === 'Loss' ? 'text-red-600' : 'text-yellow-600'}">${parlay.result}</strong>
                </div>
                <div class="parlay-card-detail">
                    <span class="text-gray-600">Wagered:</span> <strong>$${parlay.amountWagered.toFixed(2)}</strong>
                </div>
                <div class="parlay-card-detail">
                    <span class="text-gray-600">Won/Loss:</span> <strong class="${wonLossClass}">${wonLossSign}$${parlay.amountWonLoss.toFixed(2)}</strong>
                </div>
                <!-- The ::after pseudo-element on .parlay-card-summary no longer provides the +/– indicator text -->
            </div>
            
            <div class="parlay-card-toggle-details hidden">
                <div class="parlay-card-detail mt-3">
                    <span class="text-gray-600">Type:</span> <strong>${parlay.playType}</strong>
                </div>
                <div class="parlay-card-bets mt-2">
                    <p class="text-sm font-medium text-gray-700 mb-1">Individual Bets:</p>
                    <ul>
                        ${betsHtml}
                    </ul>
                </div>
            </div>

            <div class="parlay-card-actions">
                <button onclick="tracker.editParlay(${index})" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-md text-sm hover:bg-indigo-200">Edit</button>
                <button onclick="tracker.deleteParlay(${index})" class="bg-red-100 text-red-700 px-3 py-1 rounded-md text-sm hover:bg-red-200">Delete</button>
            </div>
        `;

        // Add event listener to toggle details when the summary part of the card is clicked
        card.querySelector('.parlay-card-summary').addEventListener('click', (event) => {
            // Prevent event from bubbling up and interfering with other card clicks if any
            event.stopPropagation(); 
            const toggleDetailsDiv = card.querySelector('.parlay-card-toggle-details');
            const parlayCardSummary = card.querySelector('.parlay-card-summary'); 

            toggleDetailsDiv.classList.toggle('hidden'); // Toggle visibility
            parlayCardSummary.classList.toggle('expanded'); // Toggle class for pseudo-element change (now unused but harmless)
        });

        return card;
    }

    updateSummaryStatistics() {
        let totalWagered = 0;
        let netProfitLoss = 0;
        let totalWins = 0;
        let totalLosses = 0;
        let totalPushes = 0;
        let totalIndividualBets = 0;
        let individualBetWins = 0;
        let individualBetLosses = 0;
        let individualBetPushes = 0;

        this.parlays.forEach(parlay => {
            totalWagered += parlay.amountWagered;
            netProfitLoss += parlay.amountWonLoss;

            if (parlay.result === 'Win') {
                totalWins++;
            } else if (parlay.result === 'Loss') {
                totalLosses++;
            } else if (parlay.result === 'Push') {
                totalPushes++;
            }

            parlay.bets.forEach(bet => {
                totalIndividualBets++;
                if (bet.individualResult === 'Win') {
                    individualBetWins++;
                } else if (bet.individualResult === 'Loss') {
                    individualBetLosses++;
                } else if (bet.individualResult === 'Push') {
                    individualBetPushes++;
                }
            });
        });

        this.totalWageredSpan.textContent = totalWagered.toFixed(2);
        this.netProfitLossSpan.textContent = netProfitLoss.toFixed(2);
        // Apply +/- sign for netProfitLoss
        this.netProfitLossSpan.parentNode.style.color = netProfitLoss > 0 ? '#10B981' : (netProfitLoss < 0 ? '#EF4444' : '#6B7280'); // Green for win, red for loss, gray for neutral
        this.netProfitLossSpan.textContent = `${netProfitLoss > 0 ? '+' : ''}${netProfitLoss.toFixed(2)}`;

        this.totalWinsSpan.textContent = totalWins;
        this.totalLossesSpan.textContent = totalLosses;
        this.totalPushesSpan.textContent = totalPushes;
        this.totalParlaysSpan.textContent = this.parlays.length;

        this.calculateAndDisplaySuccessPercentage(
            totalWins, totalLosses, totalPushes, 
            individualBetWins, individualBetLosses, individualBetPushes, 
            this.parlays.length, totalIndividualBets
        );
    }

    calculateAndDisplaySuccessPercentage(
        totalWins, totalLosses, totalPushes, 
        individualBetWins, individualBetLosses, individualBetPushes, 
        totalParlays, totalIndividualBets
    ) {
        let successPercentage = 0;
        if (this.currentSuccessCalcMethod === 'parlays') {
            const totalOutcomes = totalWins + totalLosses + totalPushes;
            if (totalOutcomes > 0) {
                successPercentage = (totalWins / totalOutcomes) * 100;
            }
        } else { // 'props'
            const totalOutcomes = individualBetWins + individualBetLosses + individualBetPushes;
            if (totalOutcomes > 0) {
                successPercentage = (individualBetWins / totalOutcomes) * 100;
            }
        }
        this.successPercentageSpan.textContent = successPercentage.toFixed(2);
    }

    handleSuccessCalcChange(event) {
        this.currentSuccessCalcMethod = event.target.value;
        this.saveData(); // Save the preference
        this.updateSummaryStatistics(); // Re-calculate with new method
    }

    resetForm() {
        this.parlayForm.reset();
        this.playerPropInputsContainer.innerHTML = '';
        this.addPlayerPropRow(); // Ensure there's always one empty row
        this.editingIndex = -1;
        this.submitBtn.textContent = 'Add Parlay Entry';
        // Reset colors for amountWonLoss input border
        this.amountWageredInput.classList.remove('border-red-500');
        this.amountWonLossInput.classList.remove('border-red-500');
        // Reset auto-calculated field
        this.amountWonLossInput.value = '';
    }

    // Modal methods
    initializeUI() {
        this.renderParlays();
        this.addPlayerPropRow(); // Add the initial player prop row
        this.showWelcomeModalIfNeeded();
    }

    showWelcomeModalIfNeeded() {
        const hasVisited = localStorage.getItem('hasVisitedAyaw');
        if (!hasVisited) {
            this.welcomeModal.classList.add('show');
            this.welcomeModal.classList.remove('hidden');
        } else {
            this.welcomeModal.classList.add('hidden');
            this.welcomeModal.classList.remove('show');
        }
    }

    closeWelcomeModal() {
        this.welcomeModal.classList.remove('show');
        this.welcomeModal.classList.add('hidden');
        localStorage.setItem('hasVisitedAyaw', 'true');
    }

    // ADD handleKeyboardShortcuts() METHOD HERE
    handleKeyboardShortcuts(event) {
        // Prevent default browser behavior for common shortcuts if we're handling them
        if ((event.ctrlKey || event.metaKey) && event.key === 'z') { // Ctrl+Z or Cmd+Z for Undo
            event.preventDefault();
            this.undo();
        }
        // Add other shortcuts here as needed, e.g.:
        // if (event.key === 'Escape' && !this.welcomeModal.classList.contains('hidden')) {
        //     event.preventDefault();
        //     this.closeWelcomeModal();
        // }
        // if ((event.ctrlKey || event.metaKey) && event.key === 's') { // Ctrl+S or Cmd+S to submit (example)
        //     event.preventDefault();
        //     this.parlayForm.requestSubmit(); // Programmatically submit the form
        // }
    }
}

// Initialize the tracker
const tracker = new ParlayTracker();
    </script>
</body>
</html>
